package com.carebridge.controllers.impl;

import com.carebridge.controllers.IController;
import com.carebridge.dao.impl.*;
import com.carebridge.dtos.CreateJournalEntryRequestDTO;
import com.carebridge.dtos.EditJournalEntryRequestDTO;
import com.carebridge.dtos.JournalEntryResponseDTO;
import com.carebridge.dtos.JwtUserDTO;
import com.carebridge.entities.JournalEntry;
import com.carebridge.entities.Journal;
import com.carebridge.entities.User;
import com.carebridge.exceptions.ApiRuntimeException;
import io.javalin.http.Context;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.time.LocalDateTime;
import java.util.List;

public class JournalEntryController implements IController<JournalEntry, Long>
{

    private static final Logger logger = LoggerFactory.getLogger(JournalEntryController.class);
    private final JournalEntryDAO journalEntryDAO = JournalEntryDAO.getInstance();
    private final JournalDAO journalDAO = JournalDAO.getInstance();
    private final UserDAO userDAO = UserDAO.getInstance();


    // Finding all entries by a journal ID
    public void findAllEntriesByJournal(Context ctx) {
        try {
            Long journalId = Long.parseLong(ctx.pathParam("journalId"));
            List<Long> ids = journalEntryDAO.getEntryIdsByJournalId(journalId);
            ctx.json(ids);
        } catch (IllegalArgumentException e) {
            ctx.status(400).result(e.getMessage());
        } catch (Exception e) {
            e.printStackTrace();
            ctx.status(500).result("Internal server error");
        }
    }

    // Create a new journal entry (logic moved from service)
    public void create(Context ctx) {
        try {
            Long journalId = Long.parseLong(ctx.pathParam("journalId"));
            CreateJournalEntryRequestDTO requestDTO = ctx.bodyAsClass(CreateJournalEntryRequestDTO.class);
            requestDTO.setJournalId(journalId);

            logger.debug("JournalEntryController-create: journalId={}, requestDTO title={}, content length={}, entryType={}, riskAssessment={}",
                    journalId, requestDTO.getTitle(),
                    requestDTO.getContent() != null ? requestDTO.getContent().length() : 0,
                    requestDTO.getEntryType(), requestDTO.getRiskAssessment());

            //Hentning af User er taget fra EventController
            var tokenUser = ctx.attribute("user");
            String email = null;
            if (tokenUser instanceof JwtUserDTO ju) email = ju.getUsername();
            else if (tokenUser instanceof com.carebridge.dtos.UserDTO du) email = du.getEmail();
            else if (tokenUser != null) email = tokenUser.toString();

            if (email == null) throw new ApiRuntimeException(401, "Unauthorized 1");

            User author = userDAO.readByEmail(email);
            if (author == null) {
                ctx.status(401).json("{\"msg\":\"Unauthorized 2\"}");
                return;
            }

            Journal journal = journalDAO.read(requestDTO.getJournalId());
            if (journal == null) {
                ctx.status(404).json("{\"msg\":\"Journal not found\"}");
                return;
            }

            if (requestDTO.getTitle() == null || requestDTO.getTitle().isBlank()) {
                ctx.status(400).json("{\"msg\":\"Title is required\"}");
                return;
            }
            if (requestDTO.getContent() == null || requestDTO.getContent().isBlank()) {
                ctx.status(400).json("{\"msg\":\"Content is required\"}");
                return;
            }
            if (requestDTO.getEntryType() == null) {
                ctx.status(400).json("{\"msg\":\"Entry type is required\"}");
                return;
            }
            if (requestDTO.getRiskAssessment() == null) {
                ctx.status(400).json("{\"msg\":\"Risk assessment is required\"}");
                return;
            }

            LocalDateTime now = LocalDateTime.now();
            JournalEntry entry = new JournalEntry();
            entry.setJournal(journal);
            entry.setAuthor(author);
            entry.setTitle(requestDTO.getTitle());
            entry.setContent(requestDTO.getContent());
            entry.setEntryType(requestDTO.getEntryType());
            entry.setRiskAssessment(requestDTO.getRiskAssessment());
            entry.setCreatedAt(now);
            entry.setUpdatedAt(now);
            entry.setEditCloseTime(now.plusHours(24));

            journalEntryDAO.create(entry);
            journalDAO.addEntryToJournal(journal, entry);

            JournalEntryResponseDTO responseDTO = new JournalEntryResponseDTO(
                    entry.getId(),
                    journal.getId(),
                    author.getId(),
                    entry.getTitle(),
                    entry.getContent(),
                    entry.getEntryType(),
                    entry.getRiskAssessment(),
                    entry.getCreatedAt(),
                    entry.getUpdatedAt(),
                    entry.getEditCloseTime()
            );

            ctx.status(201).json(responseDTO);

        } catch (NumberFormatException ex) {
            ctx.status(400).json("{\"msg\":\"Invalid journalId\"}");
        } catch (Exception e) {
            logger.error("create journal entry failed", e);
            ctx.status(500).json("{\"msg\":\"Internal error\"}");
        }
    }

    // Edit entry content (logic moved from service)
    public void update(Context ctx) {
        try {
            Long journalId = Long.parseLong(ctx.pathParam("journalId"));
            Long entryId = Long.parseLong(ctx.pathParam("entryId"));

            EditJournalEntryRequestDTO requestDTO = ctx.bodyAsClass(EditJournalEntryRequestDTO.class);

            Journal journal = journalDAO.read(journalId);
            if (journal == null) {
                throw new IllegalArgumentException("Journal not found with ID: " + journalId);
            }

            JournalEntry entry = journalEntryDAO.read(entryId);
            if (entry == null) {
                throw new IllegalArgumentException("Journal entry not found with ID: " + entryId);
            }

            if (entry.getJournal() == null || entry.getJournal().getId() == null ||
                    !entry.getJournal().getId().equals(journalId)) {
                throw new IllegalArgumentException("Journal entry does not belong to the specified journal.");
            }

            if (requestDTO.getContent() == null || requestDTO.getContent().isBlank()) {
                throw new IllegalArgumentException("Content is required.");
            }

            LocalDateTime now = LocalDateTime.now();
            if (entry.getEditCloseTime() == null || now.isAfter(entry.getEditCloseTime())) {
                throw new IllegalArgumentException("Edit window has closed for this entry.");
            }

            entry.setContent(requestDTO.getContent());
            entry.setUpdatedAt(now);

            journalEntryDAO.update(entryId, entry);

            JournalEntryResponseDTO responseDTO = new JournalEntryResponseDTO(
                    entry.getId(),
                    journal.getId(),
                    entry.getAuthor() != null ? entry.getAuthor().getId() : null,
                    entry.getTitle(),
                    entry.getContent(),
                    entry.getEntryType(),
                    entry.getRiskAssessment(),
                    entry.getCreatedAt(),
                    entry.getUpdatedAt(),
                    entry.getEditCloseTime()
            );

            ctx.status(200).json(responseDTO);

        } catch (IllegalArgumentException e) {
            ctx.status(400).result(e.getMessage());
        } catch (Exception e) {
            e.printStackTrace();
            ctx.status(500).result("Internal server error");
        }
    }

    private Long extractUserIdFromToken(Object tokenUser) {
        if (tokenUser instanceof JwtUserDTO ju) {
            var u = userDAO.readByEmail(ju.getUsername());
            return u != null ? u.getId() : null;
        } else if (tokenUser instanceof com.carebridge.dtos.UserDTO du) {
            return du.getId();
        }
        return null;
    }

    @Override
    public void delete(Context ctx)
    {

    }

    @Override
    public boolean validatePrimaryKey(Long aLong)
    {
        return false;
    }

    @Override
    public JournalEntry validateEntity(Context ctx)
    {
        return null;
    }


    // Get entry details (logic moved from service)
    public void read(Context ctx) {
        try {
            Long entryId = Long.parseLong(ctx.pathParam("entryId"));
            JournalEntry entry = journalEntryDAO.read(entryId);

            if (entry == null) {
                throw new IllegalArgumentException("Journal entry with ID " + entryId + " not found");
            }

            JournalEntryResponseDTO dto = new JournalEntryResponseDTO(
                    entry.getId(),
                    entry.getJournal() != null ? entry.getJournal().getId() : null,
                    entry.getAuthor() != null ? entry.getAuthor().getId() : null,
                    entry.getTitle(),
                    entry.getContent(),
                    entry.getEntryType(),
                    entry.getRiskAssessment(),
                    entry.getCreatedAt(),
                    entry.getUpdatedAt(),
                    entry.getEditCloseTime()
            );

            ctx.json(dto);
        } catch (IllegalArgumentException e) {
            ctx.status(400).result(e.getMessage());
        } catch (Exception e) {
            e.printStackTrace();
            ctx.status(500).result("Internal server error");
        }
    }

    @Override
    public void readAll(Context ctx)
    {

    }

}